<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Editor Revista Inmobiliaria</title>
<style>
/* ... Tus estilos originales sin cambios ... */
</style>
</head>
<body>

<h1>Envíanos Tú Revista Inmobiliaria <br>(12 Inmuebles)</h1>
<div id="note">Nota: Los campos vacíos usarán los datos que se proporcionaron el mes anterior.</div>

<form id="headerForm" novalidate>
    <div>
        <label for="nombreInmobiliaria" class="required">Nombre Inmobiliaria</label>
        <input type="text" id="nombreInmobiliaria" required />
    </div>
    <div>
        <label for="razonSocial" class="required">Razón Social</label>
        <input type="text" id="razonSocial" required />
    </div>
    <div>
        <label for="cif" class="required">CIF</label>
        <input type="text" id="cif" required />
    </div>
    <div>
        <label for="email">Email</label>
        <input type="email" id="email" />
    </div>
    <div>
        <label for="telefono">Teléfono</label>
        <input type="tel" id="telefono" />
    </div>
    <div style="grid-column: 1 / -1;">
        <label for="direccion">Dirección de la oficina</label>
        <input type="text" id="direccion" />
    </div>
    <div style="grid-column: 1 / -1;">
        <label for="logo">Cargar Logotipo</label>
        <input type="file" id="logo" accept="image/*" />
        <img id="logoPreview" alt="Previsualización logotipo" src="" />
    </div>
    <div style="grid-column: 1 / -1;">
        <label for="eslogan">Eslogan</label>
        <input type="text" id="eslogan" />
    </div>
    <div style="grid-column: 1 / -1;">
        <label for="paginaWeb">Página Web</label>
        <input type="url" id="paginaWeb" placeholder="https://www.ejemplo.com" />
    </div>
</form>

<div class="grid" id="editor"></div>
<br>
<div id="confirmCheckContainer">
    <input type="checkbox" id="confirmCheck" />
    <label for="confirmCheck">
        Confirmo que he finalizado la edición y los datos de los inmuebles están correctos, los datos no enviados, se completarán con los datos ya existentes de la edición anterior
    </label>
</div>

<button id="sendBtn">ENVIAR</button>

<script>
const GOOGLE_SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwbTJ3DfjPkDxJK5UbFA1hACGfP1Yasc-0dmz2Bislt88dUBCxbAMhPPFSHQ1TGgBk/exec";

// Previsualización logotipo
document.getElementById('logo').addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('logoPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('logoPreview').src = "";
    }
});

const container = document.getElementById('editor');
for (let i = 1; i <= 12; i++) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
        <div class="inmueble-num">Inmueble ${i}</div>
        <div class="preview" id="preview${i}">
            <img src="" alt="Vista previa" id="imgPreview${i}">
            <h3 id="titlePreview${i}">Título</h3>
            <p id="locPreview${i}">Localidad</p>
            <p id="descPreview${i}">Descripción</p>
            <p id="pricePreview${i}">Precio</p>
            <p id="energyPreview${i}">Etiqueta</p>
            <p id="saleTypePreview${i}">Tipo de operación</p>
        </div>
        <input type="file" accept="image/*" id="img${i}">
        <input type="text" placeholder="Título" id="title${i}">
        <input type="text" placeholder="Localidad" id="loc${i}">
        <textarea maxlength="175" placeholder="Descripción (máx 175 caracteres)" id="desc${i}"></textarea>
        <div class="desc-counter" id="descCount${i}">0/175</div>
        <input type="number" placeholder="Precio" id="price${i}">
        <select id="energy${i}">
            <option value="">Etiqueta energética</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="G">G</option>
        </select>
        <div class="radio-group">
            <label><input type="radio" name="saleType${i}" value="Venta"> Venta</label>
            <label><input type="radio" name="saleType${i}" value="Alquiler"> Alquiler</label>
            <label><input type="radio" name="saleType${i}" value="Alquiler con opción a compra"> Alquiler con opción a compra</label>
        </div>
    `;
    container.appendChild(card);

    const descTextarea = card.querySelector(`#desc${i}`);
    const descCounter = card.querySelector(`#descCount${i}`);
    descTextarea.addEventListener('input', () => {
        descCounter.textContent = `${descTextarea.value.length}/175`;
        updatePreview(i);
    });

    ['title', 'loc', 'price', 'energy'].forEach(field => {
        card.querySelector(`#${field}${i}`).addEventListener('input', () => updatePreview(i));
    });

    card.querySelectorAll(`input[name="saleType${i}"]`).forEach(radio => {
        radio.addEventListener('change', () => updatePreview(i));
    });

    card.querySelector(`#img${i}`).addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById(`imgPreview${i}`).src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById(`imgPreview${i}`).src = "";
        }
    });
}

function updatePreview(i) {
    const title = document.getElementById(`title${i}`).value.trim();
    const loc = document.getElementById(`loc${i}`).value.trim();
    const desc = document.getElementById(`desc${i}`).value.trim();
    const price = document.getElementById(`price${i}`).value.trim();
    const energy = document.getElementById(`energy${i}`).value;
    const saleTypeElems = document.getElementsByName(`saleType${i}`);
    let saleType = "";
    for (const radio of saleTypeElems) {
        if (radio.checked) {
            saleType = radio.value;
            break;
        }
    }

    document.getElementById(`titlePreview${i}`).textContent = title || "Título";
    document.getElementById(`locPreview${i}`).textContent = loc || "Localidad";
    document.getElementById(`descPreview${i}`).textContent = desc || "Descripción";
    document.getElementById(`pricePreview${i}`).textContent = price ? price + " €" : "Precio";
    document.getElementById(`energyPreview${i}`).textContent = energy ? "Etiqueta: " + energy : "Etiqueta energética";
    document.getElementById(`saleTypePreview${i}`).textContent = saleType || "Tipo de operación";
}

// Convertir archivo a base64
function fileToBase64(file) {
    return new Promise((resolve) => {
        if (!file) return resolve("");
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.readAsDataURL(file);
    });
}

document.getElementById('sendBtn').addEventListener('click', async () => {
    if (!document.getElementById('confirmCheck').checked) {
        alert("Debes confirmar que has finalizado la edición y que los datos son correctos.");
        return;
    }

    const nombreInmobiliaria = document.getElementById('nombreInmobiliaria');
    const razonSocial = document.getElementById('razonSocial');
    const cif = document.getElementById('cif');

    let valid = true;
    [nombreInmobiliaria, razonSocial, cif].forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('error');
            valid = false;
        } else {
            input.classList.remove('error');
        }
    });
    if (!valid) {
        alert("Por favor, completa los campos obligatorios marcados.");
        return;
    }

    const formData = {
        header: {
            nombreInmobiliaria: nombreInmobiliaria.value.trim(),
            razonSocial: razonSocial.value.trim(),
            cif: cif.value.trim(),
            email: document.getElementById('email').value.trim(),
            telefono: document.getElementById('telefono').value.trim(),
            direccion: document.getElementById('direccion').value.trim(),
            eslogan: document.getElementById('eslogan').value.trim(),
            paginaWeb: document.getElementById('paginaWeb').value.trim(),
            logoBase64: ""
        },
        inmuebles: []
    };

    // Logo
    const logoFile = document.getElementById('logo').files[0];
    formData.header.logoBase64 = await fileToBase64(logoFile);

    // Inmuebles
    for (let i = 1; i <= 12; i++) {
        const title = document.getElementById(`title${i}`).value.trim();
        const loc = document.getElementById(`loc${i}`).value.trim();
        const desc = document.getElementById(`desc${i}`).value.trim();
        const price = document.getElementById(`price${i}`).value.trim();
        const energy = document.getElementById(`energy${i}`).value;
        const saleTypeElems = document.getElementsByName(`saleType${i}`);
        let saleType = "";
        for (const radio of saleTypeElems) {
            if (radio.checked) {
                saleType = radio.value;
                break;
            }
        }
        const imgFile = document.getElementById(`img${i}`).files[0];
        const imgBase64 = await fileToBase64(imgFile);

        formData.inmuebles.push({
            title, loc, desc, price, energy, saleType, imgBase64
        });
    }

    try {
        const response = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        if (result.success) {
            alert("Datos enviados correctamente.");
        } else {
            alert("Error al enviar los datos: " + (result.message || "Error desconocido"));
        }
    } catch (error) {
        alert("Error en la conexión: " + error.message);
    }
});
</script>

</body>
</html>
